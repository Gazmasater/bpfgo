[{
	"resource": "/home/gaz358/myprog/bpfgo/bpf/trace.c",
	"owner": "C/C++: IntelliSense",
	"code": "167",
	"severity": 8,
	"message": "argument of type \"struct event_t\" is incompatible with parameter of type \"void *\"",
	"source": "C/C++",
	"startLineNumber": 163,
	"startColumn": 66,
	"endLineNumber": 163,
	"endColumn": 71
}]




–û—à–∏–±–∫–∞ missing package, you should either set the go-package flag or the GOPACKAGE env –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –¥–ª—è —É—Å–ø–µ—à–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ñ–∞–π–ª–∞ —Å –∫–æ–¥–æ–º Go –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –ø–∞–∫–µ—Ç Go, –≤ –∫–æ—Ç–æ—Ä–æ–º –±—É–¥–µ—Ç —Ä–∞–∑–º–µ—â–µ–Ω —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥.

–ß—Ç–æ–±—ã –∏—Å–ø—Ä–∞–≤–∏—Ç—å —ç—Ç—É –æ—à–∏–±–∫—É, –º–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ñ–ª–∞–≥–∞ -go-package:

–ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ bpf2go –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ Go-–∫–æ–¥–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —è–≤–Ω–æ —É–∫–∞–∑–∞—Ç—å –∏–º—è Go-–ø–∞–∫–µ—Ç–∞ —Å –ø–æ–º–æ—â—å—é —Ñ–ª–∞–≥–∞ -go-package. –ù–∞–ø—Ä–∏–º–µ—Ä:

bash
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
bpf2go trace bpf/trace.c -- -target bpf -go-package mypkg
–í —ç—Ç–æ–º –ø—Ä–∏–º–µ—Ä–µ mypkg ‚Äî —ç—Ç–æ –∏–º—è –ø–∞–∫–µ—Ç–∞, –≤ –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç —Ä–∞–∑–º–µ—â–µ–Ω —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥ Go. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –≤—ã–±—Ä–∞–ª–∏ –∏–º—è, –∫–æ—Ç–æ—Ä–æ–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –≤–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞.

–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è GOPACKAGE:

–í –∫–∞—á–µ—Å—Ç–≤–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã –º–æ–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è GOPACKAGE, —É–∫–∞–∑–∞–≤ –∏–º—è –ø–∞–∫–µ—Ç–∞. –ù–∞–ø—Ä–∏–º–µ—Ä:

bash
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
export GOPACKAGE=mypkg
bpf2go trace bpf/trace.c -- -target bpf
–í –æ–±–æ–∏—Ö —Å–ª—É—á–∞—è—Ö —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥ –±—É–¥–µ—Ç –ø–æ–º–µ—â–µ–Ω –≤ –ø–∞–∫–µ—Ç —Å –∏–º–µ–Ω–µ–º mypkg.

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∏—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª trace.c —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª bpf/trace.c —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –≤–∞—à–µ–º –ø—Ä–æ–µ–∫—Ç–µ, –∏ –ø—É—Ç—å –∫ –Ω–µ–º—É —É–∫–∞–∑–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ.

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–∏—Ö —à–∞–≥–æ–≤ –æ—à–∏–±–∫–∞ –¥–æ–ª–∂–Ω–∞ –∏—Å—á–µ–∑–Ω—É—Ç—å, –∏ –≤—ã —Å–º–æ–∂–µ—Ç–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å Go-–∫–æ–¥ –¥–ª—è –≤–∞—à–µ–≥–æ BPF-–ø—Ä–æ–≥—Ä–∞–º–º—ã.















nano ~/.bashrc   # –¥–ª—è bash

export PATH=$PATH:$HOME/go/bin


bpf2go --version

gaz358@gaz358-BOD-WXX9:~/myprog/bpfgo$ go install github.com/cilium/ebpf/cmd/bpf2go@latest
gaz358@gaz358-BOD-WXX9:~/myprog/bpfgo$ bpf2go --version
bpf2go: command not found


bpf2go trace ebpf/trace.c -- -target bpf




1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ bpf2go
–ï—Å–ª–∏ —É —Ç–µ–±—è –µ—â—ë –Ω–µ—Ç bpf2go, —É—Å—Ç–∞–Ω–æ–≤–∏ –µ–≥–æ:

sh
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
go install github.com/cilium/ebpf/cmd/bpf2go@latest
2. –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞
–î–æ–ø—É—Å—Ç–∏–º, —É —Ç–µ–±—è –ø—Ä–æ–µ–∫—Ç bpfgo, —Å–æ–∑–¥–∞–¥–∏–º –µ–≥–æ —Å—Ç—Ä—É–∫—Ç—É—Ä—É:

sh
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
bpfgo/
‚îú‚îÄ‚îÄ bpf/
‚îÇ   ‚îú‚îÄ‚îÄ trace.c  # eBPF-–ø—Ä–æ–≥—Ä–∞–º–º–∞ (—Ç–≤–æ–π –∫–æ–¥)
‚îú‚îÄ‚îÄ main.go      # Go-–ø—Ä–æ–≥—Ä–∞–º–º–∞, –∑–∞–≥—Ä—É–∂–∞—é—â–∞—è eBPF
3. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ eBPF-–∫–æ–¥–∞ (bpf/trace.c)
–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–π –∫–æ–¥ trace.c –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –Ω–æ —É–±–µ–¥–∏–º—Å—è, —á—Ç–æ –æ–Ω –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è –≤ bpf2go.

–°–æ—Ö—Ä–∞–Ω–∏ –µ–≥–æ –≤ bpf/trace.c.

4. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è eBPF-–∫–æ–¥–∞ –¥–ª—è Go
–ó–∞–ø—É—Å–∫–∞–µ–º bpf2go, —á—Ç–æ–±—ã —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å Go-–∫–æ–¥:

sh
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
cd bpfgo
bpf2go -target native bpf ./bpf/trace.c -- -I/usr/include
–≠—Ç–æ —Å–æ–∑–¥–∞—Å—Ç —Ñ–∞–π–ª—ã:

bpf_bpfel.go (–µ—Å–ª–∏ little-endian)
bpf_bpfeb.go (–µ—Å–ª–∏ big-endian)
bpf_bpf.o (—Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π eBPF)
5. –ù–∞–ø–∏—Å–∞–Ω–∏–µ Go-–∫–æ–¥–∞ (main.go)
–°–æ–∑–¥–∞–¥–∏–º main.go, –∫–æ—Ç–æ—Ä—ã–π –∑–∞–≥—Ä—É–∂–∞–µ—Ç eBPF-–ø—Ä–æ–≥—Ä–∞–º–º—É:

go
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
package main

import (
	"bytes"
	"encoding/binary"
	"fmt"
	"log"
	"os"
	"os/signal"
	"syscall"

	"github.com/cilium/ebpf"
	"github.com/cilium/ebpf/perf"
)

//go:generate bpf2go -target native bpf ./bpf/trace.c -- -I/usr/include

type ConnInfo struct {
	Pid    uint32
	SrcIP  uint32
	DstIP  uint32
	Sport  uint16
	Dport  uint16
	Comm   [64]byte
}

func main() {
	// –ó–∞–≥—Ä—É–∂–∞–µ–º eBPF-–ø—Ä–æ–≥—Ä–∞–º–º—É
	objs := bpfObjects{}
	if err := loadBpfObjects(&objs, nil); err != nil {
		log.Fatalf("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ BPF: %v", err)
	}
	defer objs.Close()

	// –û—Ç–∫—Ä—ã–≤–∞–µ–º –∫–∞–Ω–∞–ª —Å–æ–±—ã—Ç–∏–π
	rd, err := perf.NewReader(objs.TraceEvents, 4096)
	if err != nil {
		log.Fatalf("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–µ—Ä—Ñ-—Ä–∏–¥–µ—Ä–∞: %v", err)
	}
	defer rd.Close()

	log.Println("eBPF-–ø—Ä–æ–≥—Ä–∞–º–º–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞! –û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π...")

	// –û–±—Ä–∞–±–æ—Ç–∫–∞ SIGINT (Ctrl+C)
	stop := make(chan os.Signal, 1)
	signal.Notify(stop, os.Interrupt, syscall.SIGTERM)

	// –ß–∏—Ç–∞–µ–º —Å–æ–±—ã—Ç–∏—è –≤ —Ü–∏–∫–ª–µ
	go func() {
		for {
			record, err := rd.Read()
			if err != nil {
				log.Printf("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è: %v", err)
				continue
			}
			if record.LostSamples > 0 {
				log.Printf("–ü–æ—Ç–µ—Ä—è–Ω–æ %d —Å–æ–±—ã—Ç–∏–π", record.LostSamples)
				continue
			}

			var info ConnInfo
			if err := binary.Read(bytes.NewBuffer(record.RawSample), binary.LittleEndian, &info); err != nil {
				log.Printf("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞–Ω–Ω—ã—Ö: %v", err)
				continue
			}

			fmt.Printf("PID: %d, SrcIP: %d, DstIP: %d, Sport: %d, Dport: %d, Comm: %s\n",
				info.Pid, info.SrcIP, info.DstIP, info.Sport, info.Dport, info.Comm)
		}
	}()

	<-stop
	log.Println("–ó–∞–≤–µ—Ä—à–∞–µ–º —Ä–∞–±–æ—Ç—É.")
}
6. –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫
–ö–æ–º–ø–∏–ª–∏—Ä—É–µ–º Go-–ø—Ä–æ–≥—Ä–∞–º–º—É:

sh
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
go build -o bpfgo main.go
–ó–∞–ø—É—Å–∫–∞–µ–º:

sh
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
sudo ./bpfgo
7. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã
–¢–µ–ø–µ—Ä—å, –∫–æ–≥–¥–∞ –≤ —Å–∏—Å—Ç–µ–º–µ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç —Å–æ–±—ã—Ç–∏—è sendto –∏ recvfrom, –æ–Ω–∏ –±—É–¥—É—Ç –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞—Ç—å—Å—è eBPF-–ø—Ä–æ–≥—Ä–∞–º–º–æ–π –∏ –≤—ã–≤–æ–¥–∏—Ç—å—Å—è –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª.

–ò—Ç–æ–≥:
eBPF-–∫–æ–¥ (trace.c) –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è —Å –ø–æ–º–æ—â—å—é bpf2go.
–í main.go –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è eBPF-–ø—Ä–æ–≥—Ä–∞–º–º–∞, –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è perf event.
–î–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –∏–∑ eBPF –≤ Go –∏ –≤—ã–≤–æ–¥—è—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª—å.
–ï—Å–ª–∏ –±—É–¥—É—Ç –æ—à–∏–±–∫–∏, –º–æ–∂–µ—à—å –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å RUST_BACKTRACE=1 –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –≤—Å—ë –ª–∏ –Ω–æ—Ä–º–∞–ª—å–Ω–æ —Å –∫–æ–º–ø–∏–ª—è—Ü–∏–µ–π bpf2go. üöÄ


gaz358@gaz358-BOD-WXX9:~/Downloads$ ls
ecc  go1.24.0.linux-amd64.tar.gz


1. –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏ Go (–µ—Å–ª–∏ –µ—Å—Ç—å)
bash
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
sudo rm -rf /usr/local/go
2. –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ –∞—Ä—Ö–∏–≤–∞ –≤ /usr/local
bash
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
sudo tar -C /usr/local -xzf go1.24.0.linux-amd64.tar.gz
3. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ Go –≤ PATH
–î–æ–±–∞–≤—å –≤ ~/.bashrc (–∏–ª–∏ ~/.profile, –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å –¥—Ä—É–≥–æ–π —à–µ–ª–ª) —Å—Ç—Ä–æ–∫—É:

bash
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
export PATH=$PATH:/usr/local/go/bin
–ó–∞—Ç–µ–º –ø—Ä–∏–º–µ–Ω–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è:

bash
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
source ~/.bashrc

–ß—Ç–æ–±—ã –∑–∞–ø–æ–º–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ nano, –¥–µ–ª–∞–π —Ç–∞–∫:

–û—Ç–∫—Ä–æ–π —Ñ–∞–π–ª (–Ω–∞–ø—Ä–∏–º–µ—Ä, ~/.bashrc):
bash
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
nano ~/.bashrc
–î–æ–±–∞–≤—å —Å—Ç—Ä–æ–∫—É:
bash
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
export PATH=$PATH:/usr/local/go/bin
–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ:
–ù–∞–∂–º–∏ Ctrl + X (–≤—ã—Ö–æ–¥).
–ù–∞–∂–º–∏ Y (—Å–æ—Ö—Ä–∞–Ω–∏—Ç—å).
–ù–∞–∂–º–∏ Enter (–ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏–º—è —Ñ–∞–π–ª–∞).
–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π:
bash
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
source ~/.bashrc




//go:build ignore

#include "vmlinux.h"
#include "bpf/bpf_tracing.h"
#include "bpf/bpf_endian.h"
#include "bpf/bpf_core_read.h"

#include <bpf/bpf_helpers.h>

struct conn_info_t {
    struct sockaddr *sock_addr;
    u32 pid;
    u32 src_ip;
    u32 dst_ip;
    u32 addrlen;
    u16 sport;
    u16 dport;
    char comm[64];
};

struct event_t {
    u32 pid;
    u32 src_ip;
    u16 sport;
    char comm[64];
};

struct {
    __uint(type, BPF_MAP_TYPE_HASH);
    __uint(max_entries, 1024);
    __type(key, u32);
    __type(value, struct conn_info_t);
} conn_info_map SEC(".maps");

struct {
    __uint(type, BPF_MAP_TYPE_PERF_EVENT_ARRAY);
} events SEC(".maps");

char LICENSE[] SEC("license") = "Dual BSD/GPL";
#define AF_INET 2

SEC("tracepoint/syscalls/sys_enter_sendto")
int trace_sendto_enter(struct sys_enter_sendto_args *ctx) {
    u32 pid = bpf_get_current_pid_tgid() >> 32;
    struct conn_info_t conn_info = {};

    conn_info.pid = pid;
    bpf_get_current_comm(&conn_info.comm, sizeof(conn_info.comm));
    conn_info.sock_addr = ctx->addr;

    bpf_map_update_elem(&conn_info_map, &pid, &conn_info, BPF_ANY);
    return 0;
}

SEC("tracepoint/syscalls/sys_exit_sendto")
int trace_sendto_exit(struct sys_exit_sendto_args *ctx) {
    u32 pid = bpf_get_current_pid_tgid() >> 32;
    long ret = ctx->ret;

    if (ret < 0) {
        bpf_map_delete_elem(&conn_info_map, &pid);
        return 0;
    }

    struct conn_info_t *conn_info = bpf_map_lookup_elem(&conn_info_map, &pid);
    if (!conn_info) {
        return 0;
    }

    struct sockaddr_in addr = {};
    if (conn_info->sock_addr) {
        bpf_probe_read(&addr, sizeof(addr), conn_info->sock_addr);
        if (addr.sin_family == AF_INET) {
            conn_info->src_ip = bpf_ntohl(addr.sin_addr.s_addr);
            conn_info->sport = bpf_ntohs(addr.sin_port);
        }
    }

    struct event_t event = {
        .pid = conn_info->pid,
        .src_ip = conn_info->src_ip,
        .sport = conn_info->sport,
    };
    __builtin_memcpy(event.comm, conn_info->comm, sizeof(event.comm));

    bpf_perf_event_output(ctx, &events, BPF_F_CURRENT_CPU, &event, sizeof(event));
    bpf_map_delete_elem(&conn_info_map, &pid);
    return 0;
}
